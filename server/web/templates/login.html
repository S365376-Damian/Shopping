<link href="/static/css/login.css" rel="stylesheet">
<link href="/static/css/home.css" rel="stylesheet">
{% extends 'base_dashtreme_full_width.html' %}
<!-- tmdt css-->

{% block head %}
<title>Đăng nhập</title>
<style>
input::placeholder {
  color: #000 !important;
  opacity: 1; /* Đặt độ trong suốt nếu cần */
}
input:focus::placeholder {
    opacity: 0 !important;
  }
@media all and (max-width: 1024px) {
    .login_content{
        display: block;
        padding-bottom: 20px;
    }
    .login_content_left{
        width: 100%;
        margin-bottom: 20px;
    }
    .login_content_right{
        width: 100%;
    }
    .btn_social{
        margin: 0 90px;
    }
}

@media all and (max-width: 786px) {
    .login_list_progress{
        display: none;
    }
    .login_content{
        padding: 0 15px;
        padding-top: 145px;
    }
    .btn_social{
        margin: 0;
        margin-top: 20px;
    }
    .login_content_right_body_email, .login_content_right_body_password{
        flex-direction: column;
    }
    .input_login{
        width: 100%;
    }
    #display_login{
        margin-bottom: 40px !important;
    }
    /* .abcRioButton{
        display: 'none';
    } */
}
</style>
{% endblock %}
{% block body %}
<div class="mobile_menu">
    <div id="logo_center">
        <img style="vertical-align: middle; width: 100px;" src="../static/img/logo.jpg"></img>
    </div>
    <div class="list_mobile_menu">
        <div id="btn_menuMobile_Home" class="item_mobile_menu">Trang chủ</div>
        <div class="item_mobile_menu">Giới thiệu</div>
        <div id="btn_showListItem" class="item_mobile_menu">Shop Online
            <span  class="icon-sub-menu"><i id="changeIcon" class="fas fa-angle-down"></i></span>
        </div>
        <div class="list_sub_menu item_mobile_menu"></div>
        <div id="btn_blogs_mobile"  class="item_mobile_menu">Blog</div>
    </div>
</div>
<div id="mobile_overplay"></div>
<div class="header_home">
    <div>
        <img class="img_top_header" src="../static/img/bg_header.jpg"></img>
    </div>

    <div class="header_home_center">
        <div class="emty"></div>
        <div class="center_text_mobile">
             
        </div>
        <div class="right_center_header">
            <div class="center_text_mobile" id="my_account">Tài khoản</div>
            <div class="icon_account center_text_mobile"><i style="height:14px; width: 14px;" class="icon_cart_i far fa-user"></i></div>
            <div onclick="GotoCartPage()" style="display: flex;" class="changeCart">
                <div id="btn_cart" class="my_cart">Giỏ hàng</div>
                <div class="icon_cart"><i style="height:14px; width: 14px;" class="fas fa-shopping-cart icon_cart_i"></i></div>
                <div style="padding: 0 10px;" id="lbl_numberCart" hidden>0</div>
            </div>
        </div>
    </div> 
    
    <div class="nav_header">
        <div class="nav_header_list">
            <div class="nav_header_item">Giới thiệu</div>
            <div id="shop_online" class="nav_header_item">Shop Online
                <div class="nav_header_item_sub">
                </div>
            </div>
            <div id="btn_blogs" class="nav_header_item">Blog</div>
            <div id="btn_bars">
                <i style="font-size: 20px;" class="fa fa-bars"></i>
            </div>
        </div>
        <div id="logo" style="cursor: pointer;">
            <img class="logo" src="../static/img/logo.jpg"></img>
        </div>
        <div class="nav_header_list">
            <div class="nav_header_item" style="margin-left: auto;">Hướng dẫn mua hàng</div>
            <div id="btn_search">
                <i style="font-size: 20px;" class="fas fa-search"></i>
            </div>
        </div>
    </div>
</div>

<div class="login_list_progress">
   <div id="btn_home" class="login_show_li">Trang chủ</div>
   <span class="sep">/</span>
   <div id="btn_load" class="login_show_li">Đăng nhập vào tài khoản của bạn</div>
   <span class="sep">/</span>
   <div class="login_hide_acc">Tài khoản</div>
</div>

<div class="login_content">
    <div class="login_content_left">
        <div class="btn_social btn_login_fb"> 
            <div  style="width: 100%;">
                <i class="fab fa-facebook"></i>
                Đăng nhập với facebook
            </div>
        </div>
        <div class="btn_social btn_login_gg">
            <div style="width: 100%;">
                <i class="fab fa-google"></i>
                Đăng nhập với google
            </div>
        </div>
    </div>

    <div id="display_login" class="login_content_right">
        <div class="login_content_right_top">
            <div class="login_content_right_top_title">
                Đăng nhập tài khoản của bạn
            </div>
            <div style="text-decoration: underline; cursor: pointer;" id="login_missPassword">
                Quên mật khẩu
            </div>
        </div>
        <div  class="login_content_right_body">
            <form id="form_login">
                <div class="login_content_right_body_email">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-user login_i"></i>
                        Tài khoản
                        <span class="text-danger">*</span>
                    </div>
                    <input placeholder="Tên đăng nhập hoặc số điện thoại" id="txt_account" class="input_login" name="email" type="text" value="" maxlength="128">
                </div>
                <div class="login_content_right_body_password">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-user login_i"></i>
                        Mật khẩu
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_password" class="input_login" name="password" type="password"  autocomplete="password">
                </div>
            </form>
            <form id="form_miss" style="display: none;">
                <div id="div_email" class="login_content_right_body_email">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-user login_i"></i>
                        Email
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_emailMiss" class="input_login" name="email" type="text" value="" maxlength="128">
                </div>
                <div id="div_otp" style="display: none;" class="login_content_right_body_email">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-user login_i"></i>
                        Mã OTP
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_otp" class="input_login" name="email" type="text" value="" maxlength="128">
                </div>
                <div id="btn_missConfirm">
                    Gửi
                </div>
            </form>
        </div>
        <div class="login_content_right_bottom">
            <div>
                <div id="btn_login">
                    Đăng nhập
                </div>
                <div id="btn_register">
                    Tạo tài khoản mới
                </div>
            </div>
        </div>
    </div>

    <div id="display_register" class="login_content_right" style="display: none;">
        <div class="login_content_right_top">
            <div class="login_content_right_top_title">
                Tạo tài khoản mới
            </div>
            <div id="have_acccount">
                Đã có tài khoản?
            </div>
        </div>
        <div  class="login_content_right_body">
            <form>
                <div class="login_content_right_body_email">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-user login_i"></i>
                        Họ tên
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_name" class="input_login" type="text">
                </div>
                <div class="login_content_right_body_password">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-phone login_i"></i>
                        Số điện thoại
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_phone" class="input_login" name="password" type="number">
                </div>
                <div class="login_content_right_body_password">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-envelope login_i"></i>
                        Email
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_email" class="input_login" name="password" type="email">
                </div>
                <div class="login_content_right_body_password">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-user login_i"></i>
                        Tên đăng nhập
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_nameLogin" class="input_login" type="text">
                </div>
                <div class="login_content_right_body_password">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fas fa-map-marked login_i"></i>
                        Địa chỉ
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_address" class="input_login" type="text" autocomplete="addrerss">
                </div>
                <div class="login_content_right_body_password">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-user login_i"></i>
                        Mật khẩu
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_passWordAddUser" class="input_login" type="password" autocomplete="new-password">
                </div>
                <div class="login_content_right_body_password">
                    <div style="text-align: center; display: flex; align-items: center;">
                        <i class="fa fa-user login_i"></i>
                        Xác nhận mật khẩu
                        <span class="text-danger">*</span>
                    </div>
                    <input id="txt_passWordAddUserCheck" class="input_login" type="password" autocomplete="check-password">
                </div>
            </form>
        </div>
        <div class="login_content_right_bottom">
            <div>
                <div id="btn_addUser">
                    Đăng ký
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer_home">
    <div class="footer_home_list">
        <div class="footer_home_item">
            <div class="footer_home_item_hotline">
                <span>HOTLINE:</span>
                <a class="sdt">0896462282</a>
            </div>
            <div onclick="GotoTypePagePoliCy('bao-mat-thong-tin')" class="footer_home_item_link">Chính sách bảo mật thông tin khách hàng</div>
            <div onclick="GotoTypePagePoliCy('doi-tra-san-pham')" class="footer_home_item_link">Chính sách đổi trả sản phẩm</div>
            <div onclick="GotoTypePagePoliCy('bao-hanh')" class="footer_home_item_link">Chính sách bảo hành sản phẩm</div>
            <div onclick="GotoTypePagePoliCy('van-chuyen')" class="footer_home_item_link">Chính sách giao nhận, vận chuyển</div>
            <div onclick="GotoTypePagePoliCy('thanh-toan')" class="footer_home_item_link">Phương thức thanh toán</div>
            <div onclick="GotoTypePagePoliCy('khach-hang-than-thiet')" class="footer_home_item_link">Chính sách khách hàng thân thiết</div>
        </div>
    </div>
    <div style="width: 100%; justify-content: center; display: flex; margin-top: 20px;"><a href="https://www.facebook.com/AnQuocnT">Developed by Quốc An</a></div>
</div>

<!-- edit modal end-->

<!-- modals end -->


{% endblock %}

{% block scripts %}
<script>
g_displayLogin = true
g_showItem = false
g_userGoogle = null
g_clickGoogle = false
g_user = null
g_showMisss = false
g_sendOTP = false

$(document).ready(function () {
    if(Cookies.get("token") != null && Cookies.get("token") != ""){
        window.location.href = "/my_account";
    }
    GetTypeList()
    GetUser()
    setTimeout(function() {
        $('#signInButtonGoogle').show();
        var abcRioButton = document.querySelector('.abcRioButton');
        abcRioButton.style.removeProperty('width');
        abcRioButton.style.removeProperty('height');
        abcRioButton.style.removeProperty('display');
        abcRioButton.style.setProperty('width', '100%', 'important');
        abcRioButton.style.setProperty('height', '100%', 'important');
        // abcRioButton.style.setProperty('opacity', '0', 'important');
        $('#btn_loginGoogle').show();
    }, 1500);
});

function GetUser() 
{
    if(Cookies.get("token") == undefined) return
    request_data = {
        "token": Cookies.get("token")
    }
    host_request = gethost() + '/api/user/get'
    ajaxRequest("POST", host_request, request_data, onGetUserSuccess, genericFailCB)
}

function onGetUserSuccess(res) {
    g_user = res
    GetMyNewOrder()
}

function GetMyNewOrder() 
{
    request_data = {
        "user_pk":g_user._id.$oid
    }
    host_request = gethost() + '/api/order/getMyNew'
    ajaxRequest("POST", host_request, request_data, onGetMyNewOrderSuccess, genericFailCB)
}

function onGetMyNewOrderSuccess(res) {
    let myNewOrder = res.objects
    if(myNewOrder.length > 0){
        $("#lbl_numberCart").removeAttr('hidden')
        document.getElementById("lbl_numberCart").innerText = myNewOrder.length
        $('.changeCart').css('background-color', '#ff4136');
    }
}

function GetTypeList() {
    $('#result_table > tbody tr').remove()
    request_data = {
        "search_string": $("#txt_search").val(),
        "token": Cookies.get("token")
    }
    host_request = gethost() + '/api/type/gets'
    ajaxRequest("POST", host_request, request_data, onSearchSuccess, genericFailCB)
}

function onSearchSuccess(res) {
    var index = 1
    g_types = res.objects
    var parentElement = $('.nav_header_item_sub');
    var parentElementSub = $('.list_sub_menu');
    for (i = 0; i < g_types.length; i++) {
        var newItem = $('<div>').addClass('nav_header_item_sub_item').text(g_types[i].name);
        var newItemSub = $('<div>').addClass('item_sub_menu').text(g_types[i].name);
        newItem.attr("onClick", 'GotoTypePage("' + g_types[i]._id.$oid + '")');
        newItemSub.attr("onClick", 'GotoTypePage("' + g_types[i]._id.$oid + '")');
        parentElement.append(newItem);
        parentElementSub.append(newItemSub);
    }
}

function onSignIn(googleUser) {
    g_userGoogle = googleUser
    LoginWithGoogle()
}

function LoginWithGoogle()
{
    if(!g_clickGoogle) return
    if(g_userGoogle == null){
        showError("Bạn chưa đăng nhập với Google")
    }
    var profile = g_userGoogle.getBasicProfile();
    request_data = {
        "typeLogin" : "google",
        "phone": profile.getId(),
        "fullname": profile.getName(),
        "email": profile.getEmail(),
        "address": "",
        "password": profile.getId(),
        "level": "Customer"
    }
    host_request = gethost() + '/api/user/update'
    ajaxRequest("POST", host_request, request_data, onLoginGoogleSuccess, genericFailCB)
}

function googleSignIn() {
    var googleAuth = gapi.auth2.getAuthInstance();
    googleAuth.signIn().then(onSignIn);
}

function onLoginGoogleSuccess(res) {
    request_data = {
        "typeLogin" : "google",
        'email' : res.email,
    }
    host_request = gethost() + '/api/user/login'
    ajaxRequest("POST", host_request, request_data, onLoginSuccess, genericFailCB)
}

$("#btn_loginGoogle").click(function () {
    g_clickGoogle = true
    LoginWithGoogle()
});

$("#btn_home").click(function () {
    window.location.href = "/";
});

$("#logo").click(function () {
    window.location.href = "/";
});

$("#btn_cart").click(function () {
    window.location.href = "/cart";
});

$("#logo_center").click(function () {
    window.location.href = "/";
});

$("#btn_blogs").click(function () {
    window.location.href = "/blogs";
});

$("#btn_blogs_mobile").click(function () {
    window.location.href = "/blogs";
});

$("#btn_bars").click(function () {
    document.getElementById("mobile_overplay").style.visibility = "visible"
    document.querySelector('.mobile_menu').classList.toggle('active');
    document.querySelector('#mobile_overplay').classList.toggle('active');
});

$("#mobile_overplay").click(function () {
    document.getElementById("mobile_overplay").style.visibility = "hidden"
    document.querySelector('.mobile_menu').classList.toggle('active');
    document.querySelector('#mobile_overplay').classList.toggle('active');
});

$("#btn_menuMobile_Home").click(function () {
    window.location.href = "/";
});

$("#btn_showListItem").click(function () {
    if(!g_showItem)
    {
        document.getElementById("changeIcon").classList.remove("fas", "fa-angle-down");
        document.getElementById("changeIcon").classList.add("fas", "fa-times");
        g_showItem = true
    }else{
        document.getElementById("changeIcon").classList.remove("fas", "fa-times");
        document.getElementById("changeIcon").classList.add("fas", "fa-angle-down");
        g_showItem = false
    }
    document.querySelector('.list_sub_menu').classList.toggle('active');
});

$("#btn_register").click(function () {
    $("#display_login").hide()
    $("#display_register").show()
});

$("#have_acccount").click(function () {
    $("#display_login").show()
    $("#display_register").hide()
});

function Login() 
{
    if ($("#txt_account").val() == "" ||$("#txt_password").val() == "") 
    {
        showError("Thiếu email hoặc password")
        return
    }
    request_data = {
        "phone": $("#txt_account").val(),
        "nameLogin": $("#txt_account").val(),
        "password": $("#txt_password").val()
    }
    host_request = gethost() + '/api/user/login'
    ajaxRequest("POST", host_request, request_data, onLoginSuccess, genericFailCB)
}

function onLoginSuccess(res) {
    showNotice("Đăng nhập thành công!")
    setTimeout(function() {
        Cookies.set('phone', res["phone"], { expires: 365 });
        Cookies.set('token', res["token"], { expires: 365 });
        window.location.href = "/admin";
    }, 2000); // 2 giây
}

$("#btn_login").click(function () {
    Login()
});

$("#btn_addUser").click(function () {
    Register()
});

function Register() 
{
    if ($("#txt_name").val() == "") 
    {
        showError("Thiếu họ và tên")
        return
    }
    else if ($("#txt_phone").val() == "") 
    {
        showError("Thiếu số điện thoại")
        return
    }
    else if ($("#txt_email").val() == "") 
    {
        showError("Thiếu email")
        return
    }
    else if ($("#txt_address").val() == "") 
    {
        showError("Thiếu địa chỉ")
        return
    }
    else if ($("#txt_nameLogin").val() == "") 
    {
        showError("Tên đăng nhập")
        return
    }
    else if ($("#txt_passWordAddUser").val() == "") 
    {
        showError("Chưa nhập mật khẩu")
        return
    }
    if ($("#txt_passWordAddUser").val() != "") 
    {
        if($("#txt_passWordAddUser").val() != $("#txt_passWordAddUserCheck").val()){
            showError("Mật khẩu xác nhận không trùng khớp!")
            return
        }
    }
    request_data = {
        "phone": $("#txt_phone").val(),
        "fullname": $("#txt_name").val(),
        "email": $("#txt_email").val(),
        "address": $("#txt_address").val(),
        "nameLogin": $("#txt_nameLogin").val(),
        "password": $("#txt_passWordAddUser").val(),
        "level": "Customer"
    }
    host_request = gethost() + '/api/user/update'
    ajaxRequest("POST", host_request, request_data, onRegisterSuccess, genericFailCB)
}

function onRegisterSuccess(res) {
    showNotice("Đăng ký thành công!")
    setTimeout(function() {
        window.location.href = "/login";
    }, 2000); // 2 giây
}

$("#login_missPassword").click(function () {
    if(g_showMisss){
        $("#login_missPassword").html("Quên mật khẩu")
        $("#form_login").show()
        $("#form_miss").hide()
    }
    else{
        $("#login_missPassword").html("Đăng nhập")
        $("#form_login").hide()
        $("#form_miss").show()
    }
    g_showMisss = !g_showMisss
});

$("#btn_missConfirm").click(function () {
    if(g_sendOTP == true){ 
        if($("#txt_emailMiss").val() == null || $("#txt_emailMiss").val() == ""){
            showError("Bạn chưa nhập email")
            return
        }
        CheckOTPUser()
    }
    else{
        SendOTPUser()
    }
});

function SendOTPUser(){
    request_data = {
        "email": $("#txt_emailMiss").val(),
    }
    host_request = gethost() + '/api/user/sendOTP'
    ajaxRequest("POST", host_request, request_data, onSendOTPSuccess, genericFailCB)
}

function onSendOTPSuccess(res) {
    showNotice("Gửi OTP đến mail thành công")
    g_sendOTP=true
    $("#btn_missConfirm").html("Xác nhận")
    $("#div_otp").show()
    $("#div_email").hide()
}

function CheckOTPUser(){
    request_data = {
        "otp": $("#txt_otp").val(),
    }
    host_request = gethost() + '/api/user/checkOTP'
    ajaxRequest("POST", host_request, request_data, onCheckOTPSuccess, genericFailCB)
}

function onCheckOTPSuccess(res) {
    showNotice("Xác nhận thành công, chúng tôi đã gửi mật khẩu mới tới mail của bạn")
    g_sendOTP=false
    $("#btn_missConfirm").html("Gửi")
    $("#div_otp").hide()
    $("#div_email").show()
}

$(document).keydown(function (e) {
if (e.which == 13) {
    Login()
}
})

// $("#btn_resetPassword").click(function () {
//     if ($("#txt_email2").val() == "") {
//         showError("Chưa nhập email")
//         return
//     }
//     request_data = {
//         "email": $("#txt_email2").val()
//     }
//     host_request = gethost() + '/api/user/SendEmailResetPassword'
//     ajaxRequest("POST", host_request, request_data, onSendSuccess, onLoginFailed)
// });

function onSendSuccess(res) {
    showNotice(res["Success"])
    $("#reset_password_modal").modal("hide")
}

function GotoTypePage(subject_pk)
{
    g_subject_pk = subject_pk
    window.location = "/type/?pk=" + subject_pk
}

function GotoTypePagePoliCy(name)
{
    window.location = "/policy/?name=" + name
}

function GotoCartPage(name)
{
    if(g_user == null){
        showError("Bạn chưa đăng nhập")
        setTimeout(function() {
            window.location.href = "/login";
        }, 1500)
        return
    }
    window.location.href = "/cart";
}

</script>

{% endblock %}